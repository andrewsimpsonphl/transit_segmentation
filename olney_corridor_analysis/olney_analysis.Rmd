---
title: "Olney Corridor Analysis"
author: "Zoe Yoo"
date: "12/6/2021"
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)

source("../code/segmentation_code.R")

library(tinytex)
library(tidyverse); library(tidycensus)
library(reactable) ; library(shiny)
library(sf) ; library(sp)
library(tidyverse)
library(rgeos)
library(xlsx)
library(kableExtra)
library(rphl) 
library(viridis)
library(gridExtra)
library(scales)
library(leaflet)
library(leaflet.mapboxgl)
library(leaflet.extras)
library(plotly)

options(tigris_class = "sf") # tells tidycensus to download Census geometries in the sf or Simple Feature format

```

```{r functions, include=FALSE, message=FALSE}

import_apc <- function() {
  #apc_trip_data <- read_feather("./data/preped_apc_data.feather")
  apc_trip_data <- read.csv("../data/combined_apc_dataset.csv") %>% 
    mutate(stop_id = paste0(agency_id, stop_id))
  
  output <- apc_trip_data %>% adjust_dwell_and_velo()
  
  return(output)
}

find_trip_dat_v2 <- function(apc_trip_data, stop_list) {
  
  filtered_dat <- filter_trip_list(apc_trip_data, stop_list)
  nested_trip_dat <- nest_trip_data_v2(filtered_dat)
  print(paste("Running passenger data for", count(nested_trip_dat %>% as_tibble()), "trips", sep = " "))
  
  final_dat <- lazy_dt(run_passenger_data_v3(nested_trip_dat, stop_list)) %>%
    ungroup()  %>%
    lazy_dt() %>%
    dt_unnest(calculated_pass) %>% # got rid of na_if(0) %>% 
    as_tibble()
  gc()
  return(final_dat)
}
# helper function that takes in a list of stops and the global apc_data data to run the find_trip_dat_v2 function 
help_find_trip_dat <- function(list) {
    find_trip_dat_v2(apc_data, list)
    #print(paste("Analyzing trip", .$FINAL_ID))
    #mem_used()
}

# plot daily ridership and trips 
# route_analytics is a return of analyze_segment_route() (probably)
plot_daily_ridership_trips <- function(route_analytics, subcorridor_name){
  grid.arrange(ncol=2,
  ggplot(route_analytics, aes(y = route_analytics$daily_ridership, x = route_id, label = daily_ridership)) + 
    geom_bar(stat = "identity", fill = "skyblue") +
    geom_text(position=position_dodge(width=0.9), vjust = -0.75, size = 3) +
    scale_y_continuous(name = "Total Riders Served", n.breaks = 8, limits = c(0, max(route_analytics$daily_ridership) * 1.1)) + 
    scale_x_discrete(name = "Route Number") + 
    labs(title = paste0("The Corridor Serves ", round(sum(route_analytics$daily_ridership)), " Riders per Day"),
         subtitle = subcorridor_name) +
    theme(text = element_text(size = 9)),
  ggplot(route_analytics, aes(x=route_id, y = route_analytics$trips, label = trips)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_text(position=position_dodge(width=0.9), vjust = -0.75, size = 3) +
    ylab("Daily Trips (2019)") + 
    scale_x_discrete(name = "Route Number") + 
    scale_fill_phl(palette = "main", discrete = T) +
    labs(fill= "", title = paste0("The Corridor Serves ", sum(route_analytics$trips, na.rm = TRUE), " Trips per Day")) + 
    #theme_phl() + 
    theme(legend.position = "top")+
    theme(text = element_text(size = 9))
  )
}

# interactive hourly speed line graph for a specified subcorridor 
plot_hourly_speed <- function(hourly_analytics, subcorridor_name){
    p <- ggplot(hourly_analytics) + 
      geom_line(aes(x = hourly_analytics$trip_hour, y = avg_segment_speed)) +
      geom_point(aes(x = hourly_analytics$trip_hour, y = avg_segment_speed), shape=21, size=3) + 
      scale_y_continuous(name = "Speed (MPH) - Includes Dwell Time", n.breaks = 8) +
      scale_x_continuous(name = "Hour", breaks = c(0:23)) +
      labs(title = "Hourly Speed (All Routes)", 
           subtitle = subcorridor_name)+
      theme(text = element_text(size = 9))+
      theme_phl()
    p <- ggplotly(p)
    return(p)
}

plot_ridership_by_period <- function(binned_analytics, subcorridor_name) {
  p <- ggplot(binned_analytics, aes(x = timeframe, y = daily_ridership, label = daily_ridership)) + 
      geom_bar(stat = "identity", fill="skyblue", alpha=0.7) +
      geom_text(position=position_dodge(width=0.9), vjust = -0.75, size = 3) +
      scale_y_continuous(name = "Total Riders Served", n.breaks = 5) + #, limits = c(0, max(binned_analytics$avg_speed_90_pct) * 1.1)) +
      scale_x_discrete(name = element_blank()) +
      labs(title = "Ridership by Period (All Routes)",
           subtitle = paste0(subcorridor_name, " Sub-Corridor"))+
      theme(text = element_text(size = 9))
  return(p)
}

plot_ridership_by_route <- function(hourly_route_analytics, subcorridor_name) {
  #a <- as.data.frame(subset(df$hourly_route_analytics, subcorridor_id==id))
  ggplot(hourly_route_analytics, aes(x = hourly_route_analytics$trip_hour, y = daily_ridership, group=route_id, fill=route_id)) + 
    geom_bar(position = "stack", stat = "identity") +
    #geom_point(shape=21, size=3) + 
    scale_color_viridis(discrete = TRUE) +
    scale_y_continuous(name = "Riders Served", n.breaks = 8) +
    scale_x_continuous(name = "Hour", breaks = c(0:23)) +
    labs(title = "Hourly Ridership by Route (all directions)",
         subtitle = paste0(subcorridor_name, " Sub-Corridor")) +
    theme(text = element_text(size = 9))
}

# plots hourly ridership by route and direction
plot_ridership_by_route_dir <- function(hourly_route_direction_analytics, subcorridor_name) {
  p <- ggplot(hourly_route_direction_analytics, aes(x = hourly_route_direction_analytics$trip_hour, 
                                                    y = daily_ridership, fill=direction_id)) + 
      geom_bar(position = "stack", stat = "identity") +
      #geom_point(size=3) + 
      #scale_color_viridis(discrete = TRUE) +
      scale_y_continuous(name = "Riders Served", n.breaks = 8) +
      scale_x_continuous(name = "Hour", breaks = c(0:23)) +
      labs(title = "Hourly Ridership by Route/Direction",
           subtitle = paste0(subcorridor_name, " Sub-Corridor")) +
      theme(text = element_text(size = 9)) +
      facet_wrap(~route_id, ncol = 2) + 
      theme(text = element_text(size = 9))  +
      theme(axis.text.x = element_text(angle = 90))
  return(p)
}

plot_running_time <- function(hourly_route_direction_analytics, subcorridor_name) {
  p <- ggplot(hourly_route_direction_analytics %>% subset(avg_run >=0), aes(x = trip_hour, 
                                                                            y = avg_run, fill=direction_id)) + 
    geom_bar(position = "stack", stat = "identity") +
    #geom_point(size=3) + 
    #scale_fill_viridis(discrete = TRUE) +
    ylab("Average Running Time (Includes Dwell)") +
    scale_x_continuous(name = "Hour", breaks = c(0:23)) +
    labs(title = "Average End-to-End Running Time by Route/Direction",
         subtitle = subcorridor_name) +
    theme(text = element_text(size = 9)) +
    facet_wrap(~route_id + direction_id, ncol = 2) + 
    #theme_phl(base_size = 9)
    theme(text = element_text(size = 9), axis.text.x = element_text(angle = 90))
  return(p)
}



plot_service_hrs <- function(route_analytics, subcorridor_name) {
  p <- ggplot(route_analytics, aes(x=route_id, y = route_analytics$service_hours, label = round(route_analytics$service_hours))) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_text(position = "dodge", stat = "identity", vjust = -0.25) +
    #ggtitle("Market and JFK serve over 1,100 Bus Trips per Day") + 
    ylab("Service Hours Per Day") + 
    scale_x_discrete(name = "Route Number") + 
    scale_fill_phl(palette = "main", discrete = T) +
    labs(fill= "", title = paste0("The ", subcorridor_name, " Corridor Serves ", round(sum(route_analytics$service_hours, na.rm = TRUE), 1), " Service Hours per Day")) + 
    #theme_phl() + 
    theme(legend.position = "top")+
    theme(text = element_text(size = 9))
  return(p)
}

plot_speed_by_period <- function(binned_analytics, subcorridor_name) {
  p <- ggplot(binned_analytics, aes(x = timeframe, y = avg_segment_speed)) + 
    geom_bar(stat = "identity", fill="skyblue", alpha=0.7) +
    geom_errorbar(data = binned_analytics, stat = "identity", ymin = binned_analytics$avg_speed_10_pct, ymax =
                    binned_analytics$avg_speed_90_pct, colour="orange", alpha=0.6, size=1.3, width = 0.4) + 
    scale_y_continuous(name = "Speed (MPH) - Includes Dwell Time", n.breaks = 8, 
                       limits = c(0, max(binned_analytics$avg_speed_90_pct) * 1.1)) +
    scale_x_discrete(name = element_blank()) +
    labs(title = "Speed by Period (All Routes)",
         subtitle = paste0(subcorridor_name, " Sub-Corridor"))+
    theme(text = element_text(size = 9))
  return(p)
}

plot_speed_by_route_dir <- function(hourly_route_direction_analytics, subcorridor_name) {
  p<- ggplot(hourly_route_direction_analytics, aes(x = hourly_route_direction_analytics$trip_hour, 
                                                   y = avg_segment_speed, color=direction_id)) + 
        geom_line() +
        geom_point(size=1.5) + 
        #scale_color_viridis(discrete = TRUE) +
        scale_y_continuous(name = "Speed (MPH) - Includes Dwell Time", n.breaks = 8) +
        scale_x_continuous(name = "Hour", breaks = c(0:23)) +
        labs(title = "Hourly Speed by Route/Direction",
             subtitle = paste0(subcorridor_name, " Sub-Corridor")) +
        theme(text = element_text(size = 9)) +
        facet_wrap(~route_id, ncol = 2) + 
        theme(text = element_text(size = 9)) +
        theme(axis.text.x = element_text(angle = 90))
  return(p)
}

```


## Overall Corridor Analysis

### Broad Descriptive Stats

```{r data_map, include=FALSE, message=FALSE}

apc_data <- import_apc()

# create a new section where we create subcorridor data
# I added Olney as a whole into this df to test out the plot functions, could take it out later
stop_list <- I(list(c("SEPTA372","SEPTA15911","SEPTA15794", "SEPTA15912", "SEPTA15789", "SEPTA15915", "SEPTA15586", "SEPTA15793", "SEPTA15913","SEPTA15791", "SEPTA15914", "SEPTA15792", "SEPTA15786", "SEPTA15916", "SEPTA15782", "SEPTA15917", "SEPTA15587", "SEPTA16979", "SEPTA15779", "SEPTA15918", "SEPTA15919"),c("SEPTA15796", "SEPTA15908", "SEPTA15798", "SEPTA15907", "SEPTA15799", "SEPTA15800", "SEPTA16966", "SEPTA15814", "SEPTA16965", "SEPTA381", "SEPTA15795", "SEPTA373", "SEPTA15910"),c("SEPTA16963", "SEPTA15815", "SEPTA16964", "SEPTA15817","SEPTA15819", "SEPTA16961", "SEPTA32312", "SEPTA16960", "SEPTA15820", "SEPTA16959", "SEPTA15822", "SEPTA15697", "SEPTA15899", "SEPTA15818", "SEPTA16962")))
subcorridor_name <- c("Olney and Chelten - Olney and Broad", "Olney and Broad - Olney and 7th", "Olney and 7th - Olney and Front")
subcorridor_id <- c("CB","B7","7F")
subcorridors <- data.frame(subcorridor_id,subcorridor_name,stop_list)


# map find_trip_dat across the corridors and save that data as dat
# also maps binned, hourly, route, and direction analytics
subcorridors_dat <- subcorridors %>%
  mutate(dat = map(stop_list, help_find_trip_dat),
         analytics = map(dat, analyze_segment),
         route_analytics = map(dat, analyze_segment_route),
         binned_analytics = map(dat, suppressWarnings(analyze_segment_hourbin)),
         hourly_analytics = map(dat, suppressWarnings(analyze_segment_hourly)),
         hourly_route_analytics = map(dat, suppressWarnings(analyze_segment_route_hourly)),
         hourly_route_direction_analytics = map(dat,suppressWarnings(analyze_segment_route_direction_hourly)),
  )

# map plots to subcorridors_dat 
subcorridors_results <- subcorridors_dat %>% 
  mutate(daily_ridership_trips_plot = map(route_analytics, plot_daily_ridership_trips, subcorridor_name),
         hourly_speed_plot = map(hourly_analytics, plot_hourly_speed, subcorridor_name),
         ridership_by_period_plot = map(binned_analytics, plot_ridership_by_period, subcorridor_name),
         ridership_by_route_plot = map(hourly_route_direction_analytics, plot_ridership_by_route, subcorridor_name),
         ridership_by_route_dir_plot = map(hourly_route_direction_analytics, plot_ridership_by_route_dir, subcorridor_name),
         running_time_dir_plot = map(hourly_route_direction_analytics, plot_running_time, subcorridor_name),
         service_hrs_plot = map(route_analytics, plot_service_hrs, subcorridor_name),
         speed_by_period_plot = map(binned_analytics, plot_speed_by_period, subcorridor_name),
         speed_by_route_dir_plot = map(hourly_route_direction_analytics, plot_speed_by_route_dir, subcorridor_name)
         )

stop_list <- unlist(stop_list)

#create_stops()
stops_w_ridership <- st_read("../data/stops_ridership.geojson", quiet = TRUE) %>% 
    mutate_if(is.factor, as.character) %>% 
    mutate(route_list = as.list(strsplit(as.character(route_str), ",")))
#create_routes()
routes_w_ridership <- st_read("../data/routes_ridership.geojson", quiet = TRUE) %>% 
    mutate_if(is.factor, as.character)
# import links
links <- st_read("../data/links_with_stops.geojson", quiet = TRUE) 
link_stop_data <- links %>% mutate(fromto = as.character(fromto), secondLocationID = as.character(secondLocationID)) %>% 
    mutate(stop_list = as.list(strsplit(as.character(stop_str), ","))) 
# import APC data
apc_data <- read.csv("../data/combined_apc_dataset.csv") %>%  
    mutate(stop_id = paste0(agency_id, stop_id)) %>% 
    mutate(dwell_time = case_when(
        agency_id == "NJT" ~ dwell_time * 60,
        TRUE ~ dwell_time
    ))
apc_data <- adjust_dwell_and_velo(apc_data)

alltracts <- st_read("https://opendata.arcgis.com/datasets/8bc0786524a4486bb3cf0f9862ad0fbf_0.geojson", quiet = TRUE)
#restrict to just tracts that stops are in


#pulling the acs data
acs_trans <- c("B08301_001", #workers
              "B08301_002", #means of transportation to work: car
              "B08301_003", #means of transportation to work: car, drove alone
              "B08301_010", #means of transportation to work: public transit
              "B08301_011", #means of transportation to work: public transit, bus
              "B08301_012", #means of transportation to work: public transit, subway
              "B08301_013", #means of transportation to work: public transit, commuter rail
              "B08301_014", #means of transportation to work: public transit, light rail/trolley
              "B08301_016", #means of transportation to work: taxicab
              "B08301_018", #means of transportation to work: bicycle
              "B08301_019", #means of transportation to work: walked
              "B08301_021" #means of transportation to work: wfh
              )

trip_dat <- (find_trip_dat_v2(apc_data, stop_list))

analytics <- analyze_segment(trip_dat)
route_analytics <- analyze_segment_route(trip_dat)
binned_analytics <- suppressWarnings(analyze_segment_hourbin(trip_dat))
hourly_analytics <- suppressWarnings(analyze_segment_hourly(trip_dat))
hourly_route_analytics <- suppressWarnings(analyze_segment_route_hourly(trip_dat))
hourly_route_direction_analytics <- suppressWarnings(analyze_segment_route_direction_hourly(trip_dat))

routes <- subset(routes_w_ridership, routes_w_ridership$Route %in% trip_dat$route_id) 

```

```{r}





```


The Olney transit corridor runs along Olney Ave between Chelten Avenue and Front Street. The 18 and 26 are the two routes that run along the corridor, both crossing North Broad Street past the Olney Transportation Center. The Transportation Center has a stop for the Broad Street Line, while there is also a stop for the Fox Station Regional Rail line at the end of the corridor adjacent to Olney & Front Street. There are `length(subcorridors[[3]][[1]])` total bus stops along the corridor, with the average bus trip running past `round(mean(subcorridors_dat[[4]][[1]]$n_stops))` stops spanning `round(mean(subcorridors_dat[[4]][[1]]$distance_traveled),digits=2)` miles.

```{r leaflet_map, include=TRUE, message=FALSE}
  
# map of routes that exist in this corridor
leaflet() %>%
  setView(lng = -75.14511, lat = 40.03905, zoom = 13) %>% 
  addProviderTiles(providers$Stamen.Toner) #%>% 
  #addPolylines(data = routes_w_ridership, color = "#4377bc", weight = 4, layerId = link_stop_data$fromto, opacity = 0.5)

# also add chart/table of global averages for context of subcorridors
```


### Corridor Level Descriptive Stats

These charts illustrate characteristics for the Olney corridor as a whole, such as average speed and ridership. Average speed, as well as riderhship, vary both by route and by time of day.

```{r corridor_level}

table_1 <- route_analytics %>% bind_rows(analytics %>% mutate(route_id = "Total"))
 
kable(table_1, booktabs = TRUE, align = 'c',format.args = list(big.mark = ","),digits=1) %>%
  kable_styling(latex_options = "scale_down")  %>%
  row_spec(dim(table_1)[1], bold = T) %>% # format last row
  column_spec(1, italic = T) %>%  # format first column
  scroll_box(width = "100%", height = "300px")

# ggplot(route_analytics, aes(x = route_id, y = avg_segment_speed)) + 
#   geom_bar(stat = "identity", fill="skyblue", alpha=0.7) +
#   geom_errorbar(data = route_analytics, stat = "identity", ymin = route_analytics$avg_speed_10_pct, ymax = route_analytics$avg_speed_90_pct, colour="orange", alpha=0.6, size=1.3, width = 0.4) + 
#   scale_y_continuous(name = "Speed (MPH) - Includes Dwell Time", n.breaks = 8, limits = c(0, max(route_analytics$avg_speed_90_pct) * 1.1)) +
#   scale_x_discrete(name = "Route Number") + 
#   labs(title = paste0("The Average Bus Travels at ", round(mean(analytics$avg_segment_speed), 1), " MPH on the Corridor")) +
#   theme(text = element_text(size = 9))


#will have to change the Olney plots to work with the new function structure
#plot_hourly_speed(subcorridors_dat,"OL")

#plot_speed_by_period(subcorridors_dat, "OL")

#plot_ridership_by_period(subcorridors_dat, "OL")

```


### Corridor/Route Level Stats

Here, we separate overall corridor statistics by route to better understand the makeup of Olney bus traffic. The first three graphs, which cover ridership (both average daily ridership and average ridership per hour), the number of trips, and number of service hours per route, aggregate for both directions of each route. Next, average hourly ridership is again shown, but divided by whether the bus was Eastbound or Westbound (as Olney runs E-W). Average corridor running time, or the time it takes for a bus to make one trip along the corridor, and average hourly speed are also differentiated by direction.


```{r corridor-route-level}

# plot_daily_ridership_trips(subcorridors_dat,"OL")
# 
# plot_service_hrs(subcorridors_dat,"OL")
# 
# plot_ridership_by_route(subcorridors_dat, "OL")
# 
# plot_ridership_by_route_dir(subcorridors_dat, "OL")
# 
# plot_running_time(subcorridors_dat, "OL")
# 
# plot_speed_by_route_dir(subcorridors_dat, "OL")


```
*Note: average speed and running time are calculated for the entire running time, including dwell times.*


## Sub-Corridor Analysis

There are three main "sub-corridors" within the Olney corridor: Chelten to Broad, which is the section west of Broad St, Broad to 7th, and 7th to Front, which are both east of Broad St.

### Chelten to Broad

```{r chelten_broad, message=FALSE}
#stop_cb <- c("SEPTA372","SEPTA15911","SEPTA15794", "SEPTA15912", "SEPTA15789", "SEPTA15915", "SEPTA15586", "SEPTA15793", "SEPTA15913","SEPTA15791", "SEPTA15914", "SEPTA15792", "SEPTA15786", "SEPTA15916", "SEPTA15782", "SEPTA15917", "SEPTA15587", "SEPTA16979", "SEPTA15779", "SEPTA15918", "SEPTA15919")

subcorridors_results$daily_ridership_trips_plot[[1]]

subcorridors_results$hourly_speed_plot[[1]]

subcorridors_results$speed_by_route_dir_plot[[1]]

```


### Broad to 7th

```{r broad_7th, message=FALSE}

# stop_b7 <- c("SEPTA15796", "SEPTA15908", "SEPTA15798", "SEPTA15907", "SEPTA15799", "SEPTA15800", "SEPTA16966", "SEPTA15814", "SEPTA16965", "SEPTA381", "SEPTA15795", "SEPTA373", "SEPTA15910")

subcorridors_results$daily_ridership_trips_plot[[2]]

subcorridors_results$hourly_speed_plot[[2]]

subcorridors_results$speed_by_route_dir_plot[[2]]

```


### 7th to Front

```{r 7th_front, message=FALSE}

#stop_7f <- c("SEPTA16963", "SEPTA15815", "SEPTA16964", "SEPTA15817","SEPTA15819", "SEPTA16961", "SEPTA32312", "SEPTA16960", "SEPTA15820", "SEPTA16959", "SEPTA15822", "SEPTA15697", "SEPTA15899", "SEPTA15818", "SEPTA16962")

subcorridors_results$daily_ridership_trips_plot[[3]]

subcorridors_results$hourly_speed_plot[[3]]

subcorridors_results$speed_by_route_dir_plot[[3]]

```


