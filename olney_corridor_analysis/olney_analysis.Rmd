---
title: "Olney Corridor Analysis"
author: "Zoe Yoo"
date: "12/6/2021"
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)

source("../code/segmentation_code.R")

library(tinytex)
library(tidyverse); library(tidycensus)
library(reactable) ; library(shiny)
library(sf) ; library(sp)
library(tidyverse)
library(rgeos)
library(xlsx)
library(kableExtra)
library(rphl) 
library(viridis)
library(gridExtra)
library(scales)
library(leaflet)
library(leaflet.mapboxgl)
library(leaflet.extras)
library(plotly)
library(parallel)
library(furrr)

options(tigris_class = "sf") # tells tidycensus to download Census geometries in the sf or Simple Feature format

```

```{r functions, include=FALSE, message=FALSE}

# ZOE - WE DON'T WANT TO HAVE SEPERATE VERSION OF THESE FUNCTIONS IN THIS FILE. 
# WE REALLY JUST WANT TO PULL DIRECLY FROM segmentation_code. 
# are there any changes you've made here or are they just copied over? If they're just copies, please delete

import_apc <- function() {
  #apc_trip_data <- read_feather("./data/preped_apc_data.feather")
  apc_trip_data <- read.csv("../data/combined_apc_dataset.csv") %>% 
    mutate(stop_id = paste0(agency_id, stop_id))
  
  output <- apc_trip_data %>% adjust_dwell_and_velo()
  
  return(output)
}

find_trip_dat_v2 <- function(apc_trip_data, stop_list) {
  
  filtered_dat <- filter_trip_list(apc_trip_data, stop_list)
  nested_trip_dat <- nest_trip_data_v2(filtered_dat)
  print(paste("Running passenger data for", count(nested_trip_dat %>% as_tibble()), "trips", sep = " "))
  
  final_dat <- lazy_dt(run_passenger_data_v3(nested_trip_dat, stop_list)) %>%
    ungroup()  %>%
    lazy_dt() %>%
    dt_unnest(calculated_pass) %>% # got rid of na_if(0) %>% 
    as_tibble()
  gc()
  return(final_dat)
}
# helper function that takes in a list of stops and the global apc_data data to run the find_trip_dat_v2 function 
help_find_trip_dat <- function(list) {
    suppressMessages(find_trip_dat_v2(apc_data, list))
    #print(paste("Analyzing trip", .$FINAL_ID))
    #mem_used()
}


## PLOT FUNCTIONS ##

# plot daily ridership and trips 
# route_analytics is a return of analyze_segment_route() (probably)
plot_daily_ridership_trips <- function(route_analytics, subcorridor_name){
  grid.arrange(ncol=2,
  ggplot(route_analytics, aes(y = route_analytics$daily_ridership, x = route_id, label = daily_ridership)) + 
    geom_bar(stat = "identity", fill = "skyblue") +
    geom_text(position=position_dodge(width=0.9), vjust = -0.75, size = 3) +
    scale_y_continuous(name = "Total Riders Served", n.breaks = 8, limits = c(0, max(route_analytics$daily_ridership) * 1.1)) + 
    scale_x_discrete(name = "Route Number") + 
    labs(title = paste0("The Corridor Serves ", round(sum(route_analytics$daily_ridership)), " Riders per Day"),
         subtitle = subcorridor_name) +
    theme(text = element_text(size = 9)),
  ggplot(route_analytics, aes(x=route_id, y = route_analytics$trips, label = trips)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_text(position=position_dodge(width=0.9), vjust = -0.75, size = 3) +
    ylab("Daily Trips (2019)") + 
    scale_x_discrete(name = "Route Number") + 
    scale_fill_phl(palette = "main", discrete = T) +
    labs(fill= "", title = paste0("The Corridor Serves ", sum(route_analytics$trips, na.rm = TRUE), " Trips per Day")) + 
    #theme_phl() + 
    theme(legend.position = "top")+
    theme(text = element_text(size = 9))
  )
  
}

# interactive hourly speed line graph for a specified subcorridor 
plot_hourly_speed <- function(hourly_analytics, subcorridor_name){
    p <- ggplot(hourly_analytics) + 
      geom_line(aes(x = hourly_analytics$trip_hour, y = avg_segment_speed)) +
      geom_point(aes(x = hourly_analytics$trip_hour, y = avg_segment_speed), shape=21, size=3) + 
      scale_y_continuous(name = "Speed (MPH) - Includes Dwell Time", n.breaks = 8) +
      scale_x_continuous(name = "Hour", breaks = c(0:23)) +
      labs(title = "Hourly Speed (All Routes)", 
           subtitle = subcorridor_name)+
      theme(text = element_text(size = 9))+
      theme_phl()
    p <- ggplotly(p)
    return(p)
}

plot_ridership_by_period <- function(binned_analytics, subcorridor_name) {
  p <- ggplot(binned_analytics, aes(x = timeframe, y = daily_ridership, label = daily_ridership)) + 
      geom_bar(stat = "identity", fill="skyblue", alpha=0.7) +
      geom_text(position=position_dodge(width=0.9), vjust = -0.75, size = 3) +
      scale_y_continuous(name = "Total Riders Served", n.breaks = 5) + #, limits = c(0, max(binned_analytics$avg_speed_90_pct) * 1.1)) +
      scale_x_discrete(name = element_blank()) +
      labs(title = "Ridership by Period (All Routes)",
           subtitle = paste0(subcorridor_name, " Sub-Corridor"))+
      theme(text = element_text(size = 9))
  return( ggplotly(p))
}

plot_ridership_by_route <- function(hourly_route_analytics, subcorridor_name) {
  #a <- as.data.frame(subset(df$hourly_route_analytics, subcorridor_id==id))
  p <- ggplot(hourly_route_analytics, aes(x = hourly_route_analytics$trip_hour, y = daily_ridership, group=route_id, fill=route_id)) + 
    geom_bar(position = "stack", stat = "identity") +
    #geom_point(shape=21, size=3) + 
    scale_color_viridis(discrete = TRUE) +
    scale_y_continuous(name = "Riders Served", n.breaks = 8) +
    scale_x_continuous(name = "Hour", breaks = c(0:23)) +
    labs(title = "Hourly Ridership by Route (all directions)",
         subtitle = paste0(subcorridor_name, " Sub-Corridor")) +
    theme(text = element_text(size = 9))
  
  return( ggplotly(p))
}

# plots hourly ridership by route and direction
plot_ridership_by_route_dir <- function(hourly_route_direction_analytics, subcorridor_name) {
  p <- ggplot(hourly_route_direction_analytics, aes(x = hourly_route_direction_analytics$trip_hour, 
                                                    y = daily_ridership, fill=direction_id)) + 
      geom_bar(position = "stack", stat = "identity") +
      #geom_point(size=3) + 
      #scale_color_viridis(discrete = TRUE) +
      scale_y_continuous(name = "Riders Served", n.breaks = 8) +
      scale_x_continuous(name = "Hour", breaks = c(0:23)) +
      labs(title = "Hourly Ridership by Route/Direction",
           subtitle = paste0(subcorridor_name, " Sub-Corridor")) +
      theme(text = element_text(size = 9)) +
      facet_wrap(~route_id, ncol = 2) + 
      theme(text = element_text(size = 9))  +
      theme(axis.text.x = element_text(angle = 90))
  return( ggplotly(p))
}

plot_running_time <- function(hourly_route_direction_analytics, subcorridor_name) {
  p <- ggplot(hourly_route_direction_analytics %>% subset(avg_run >=0), aes(x = trip_hour, 
                                                                            y = avg_run, fill=direction_id)) + 
    geom_bar(position = "stack", stat = "identity") +
    #geom_point(size=3) + 
    #scale_fill_viridis(discrete = TRUE) +
    ylab("Average Running Time (Includes Dwell)") +
    scale_x_continuous(name = "Hour", breaks = c(0:23)) +
    labs(title = "Average End-to-End Running Time by Route/Direction",
         subtitle = subcorridor_name) +
    theme(text = element_text(size = 9)) +
    facet_wrap(~route_id + direction_id, ncol = 2) + 
    #theme_phl(base_size = 9)
    theme(text = element_text(size = 9), axis.text.x = element_text(angle = 90))
  return( ggplotly(p))
}



plot_service_hrs <- function(route_analytics, subcorridor_name) {
  p <- ggplot(route_analytics, aes(x=route_id, y = route_analytics$service_hours, label = round(route_analytics$service_hours))) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_text(position = "dodge", stat = "identity", vjust = -0.25) +
    #ggtitle("Market and JFK serve over 1,100 Bus Trips per Day") + 
    ylab("Service Hours Per Day") + 
    scale_x_discrete(name = "Route Number") + 
    scale_fill_phl(palette = "main", discrete = T) +
    labs(fill= "", title = paste0("The ", subcorridor_name, " Corridor Serves ", round(sum(route_analytics$service_hours, na.rm = TRUE), 1), " Service Hours per Day")) + 
    #theme_phl() + 
    theme(legend.position = "top")+
    theme(text = element_text(size = 9))
  return( ggplotly(p))
}

plot_speed_by_period <- function(binned_analytics, subcorridor_name) {
  p <- ggplot(binned_analytics, aes(x = timeframe, y = avg_segment_speed)) + 
    geom_bar(stat = "identity", fill="skyblue", alpha=0.7) +
    geom_errorbar(data = binned_analytics, stat = "identity", ymin = binned_analytics$avg_speed_10_pct, ymax =
                    binned_analytics$avg_speed_90_pct, colour="orange", alpha=0.6, size=1.3, width = 0.4) + 
    scale_y_continuous(name = "Speed (MPH) - Includes Dwell Time", n.breaks = 8, 
                       limits = c(0, max(binned_analytics$avg_speed_90_pct) * 1.1)) +
    scale_x_discrete(name = element_blank()) +
    labs(title = "Speed by Period (All Routes)",
         subtitle = paste0(subcorridor_name, " Sub-Corridor"))+
    theme(text = element_text(size = 9))
  return( ggplotly(p))
}

plot_speed_by_route_dir <- function(hourly_route_direction_analytics, subcorridor_name) {
  p<- ggplot(hourly_route_direction_analytics, aes(x = hourly_route_direction_analytics$trip_hour, 
                                                   y = avg_segment_speed, color=direction_id)) + 
        geom_line() +
        geom_point(size=1.5) + 
        #scale_color_viridis(discrete = TRUE) +
        scale_y_continuous(name = "Speed (MPH) - Includes Dwell Time", n.breaks = 8) +
        scale_x_continuous(name = "Hour", breaks = c(0:23)) +
        labs(title = "Hourly Speed by Route/Direction",
             subtitle = paste0(subcorridor_name, " Sub-Corridor")) +
        theme(text = element_text(size = 9)) +
        facet_wrap(~route_id, ncol = 2) + 
        theme(text = element_text(size = 9)) +
        theme(axis.text.x = element_text(angle = 90))
  return( ggplotly(p))
}

```


## Overall Corridor Analysis

### Overview

```{r data_map, include=FALSE, message=FALSE}
# setup multi core functionality
numCores <- detectCores()
plan(multisession, workers = numCores)

apc_data <- import_apc()

## ASSEMBLE FULL CORRIDOR DATA ##
full_stop_list <- I(list(c("SEPTA372","SEPTA15911","SEPTA15794", "SEPTA15912", "SEPTA15789", "SEPTA15915", "SEPTA15586", "SEPTA15793", "SEPTA15913","SEPTA15791", "SEPTA15914", "SEPTA15792", "SEPTA15786", "SEPTA15916", "SEPTA15782", "SEPTA15917", "SEPTA15587", "SEPTA16979", "SEPTA15779", "SEPTA15918", "SEPTA15919")))

full_corridor_name <- c("Olney and Chelten - Olney and Broad")
full_corridor_id <- c("full")
full_corridor_dat <- data.frame(full_corridor_id,full_corridor_name, full_stop_list) %>% 
  mutate(dat = future_map(full_stop_list, help_find_trip_dat),
         analytics = future_map(dat, analyze_segment),
         route_analytics = future_map(dat, analyze_segment_route),
         binned_analytics = future_map(dat, suppressWarnings(analyze_segment_hourbin)),
         hourly_analytics = future_map(dat, suppressWarnings(analyze_segment_hourly)),
         hourly_route_analytics = future_map(dat, suppressWarnings(analyze_segment_route_hourly)),
         hourly_route_direction_analytics = future_map(dat,suppressWarnings(analyze_segment_route_direction_hourly)))

full_corridor_results <- full_corridor_dat %>% 
  mutate(daily_ridership_trips_plot = future_map(route_analytics, plot_daily_ridership_trips, full_corridor_name),
         hourly_speed_plot = future_map(hourly_analytics, plot_hourly_speed, full_corridor_name),
         ridership_by_period_plot = future_map(binned_analytics, plot_ridership_by_period, full_corridor_name),
         ridership_by_route_plot = future_map(hourly_route_direction_analytics, plot_ridership_by_route, full_corridor_name),
         ridership_by_route_dir_plot = future_map(hourly_route_direction_analytics, plot_ridership_by_route_dir, full_corridor_name),
         running_time_dir_plot = future_map(hourly_route_direction_analytics, plot_running_time, full_corridor_name),
         service_hrs_plot = future_map(route_analytics, plot_service_hrs, full_corridor_name),
         speed_by_period_plot = future_map(binned_analytics, plot_speed_by_period, full_corridor_name),
         speed_by_route_dir_plot = future_map(hourly_route_direction_analytics, plot_speed_by_route_dir, full_corridor_name)
         )

## ASSEMBLE SUBCORRIDOR DATA ##

# create a new section where we create subcorridor data
# I added Olney as a whole into this df to test out the plot functions, could take it out later
stop_list <- I(list(c("SEPTA372","SEPTA15911","SEPTA15794", "SEPTA15912", "SEPTA15789", "SEPTA15915", "SEPTA15586", "SEPTA15793", "SEPTA15913","SEPTA15791", "SEPTA15914", "SEPTA15792", "SEPTA15786", "SEPTA15916", "SEPTA15782", "SEPTA15917", "SEPTA15587", "SEPTA16979", "SEPTA15779", "SEPTA15918", "SEPTA15919"),c("SEPTA15796", "SEPTA15908", "SEPTA15798", "SEPTA15907", "SEPTA15799", "SEPTA15800", "SEPTA16966", "SEPTA15814", "SEPTA16965", "SEPTA381", "SEPTA15795", "SEPTA373", "SEPTA15910"),c("SEPTA16963", "SEPTA15815", "SEPTA16964", "SEPTA15817","SEPTA15819", "SEPTA16961", "SEPTA32312", "SEPTA16960", "SEPTA15820", "SEPTA16959", "SEPTA15822", "SEPTA15697", "SEPTA15899", "SEPTA15818", "SEPTA16962")))
subcorridor_name <- c("Olney and Chelten - Olney and Broad", "Olney and Broad - Olney and 7th", "Olney and 7th - Olney and Front")
subcorridor_id <- c("CB","B7","7F")
subcorridors <- data.frame(subcorridor_id,subcorridor_name,stop_list)


# map find_trip_dat across the corridors and save that data as dat
# also maps binned, hourly, route, and direction analytics
subcorridors_dat <- subcorridors %>%
  mutate(dat = future_map(stop_list, help_find_trip_dat),
         analytics = future_map(dat, analyze_segment),
         route_analytics = future_map(dat, analyze_segment_route),
         binned_analytics = future_map(dat, suppressWarnings(analyze_segment_hourbin)),
         hourly_analytics = future_map(dat, suppressWarnings(analyze_segment_hourly)),
         hourly_route_analytics = future_map(dat, suppressWarnings(analyze_segment_route_hourly)),
         hourly_route_direction_analytics = future_map(dat,suppressWarnings(analyze_segment_route_direction_hourly))
  )

# map plots to subcorridors_dat 
subcorridors_results <- subcorridors_dat %>% 
  mutate(daily_ridership_trips_plot = future_map(route_analytics, plot_daily_ridership_trips, subcorridor_name),
         hourly_speed_plot = future_map(hourly_analytics, plot_hourly_speed, subcorridor_name),
         ridership_by_period_plot = future_map(binned_analytics, plot_ridership_by_period, subcorridor_name),
         ridership_by_route_plot = future_map(hourly_route_direction_analytics, plot_ridership_by_route, subcorridor_name),
         ridership_by_route_dir_plot = future_map(hourly_route_direction_analytics, plot_ridership_by_route_dir, subcorridor_name),
         running_time_dir_plot = future_map(hourly_route_direction_analytics, plot_running_time, subcorridor_name),
         service_hrs_plot = future_map(route_analytics, plot_service_hrs, subcorridor_name),
         speed_by_period_plot = future_map(binned_analytics, plot_speed_by_period, subcorridor_name),
         speed_by_route_dir_plot = future_map(hourly_route_direction_analytics, plot_speed_by_route_dir, subcorridor_name)
         )


# ZOE - what's this doing here? 
stop_list <- unlist(stop_list)

#create_stops()
stops_w_ridership <- st_read("../data/stops_ridership.geojson", quiet = TRUE) %>% 
    mutate_if(is.factor, as.character) %>% 
    mutate(route_list = as.list(strsplit(as.character(route_str), ",")))
#create_routes()
routes_w_ridership <- st_read("../data/routes_ridership.geojson", quiet = TRUE) %>% mutate_if(is.factor, as.character)
# import links
links <- st_read("../data/links_with_stops.geojson", quiet = TRUE) 
link_stop_data <- links %>% mutate(fromto = as.character(fromto), secondLocationID = as.character(secondLocationID)) %>% 
    mutate(stop_list = as.list(strsplit(as.character(stop_str), ","))) 

# ZOE - why are we importing APC data again here? is this any different than the previous data pull? 
# import APC data
apc_data <- read.csv("../data/combined_apc_dataset.csv") %>%  
    mutate(stop_id = paste0(agency_id, stop_id)) %>% 
    mutate(dwell_time = case_when(
        agency_id == "NJT" ~ dwell_time * 60,
        TRUE ~ dwell_time
    ))
apc_data <- adjust_dwell_and_velo(apc_data)

#alltracts <- st_read("https://opendata.arcgis.com/datasets/8bc0786524a4486bb3cf0f9862ad0fbf_0.geojson", quiet = TRUE)
#restrict to just tracts that stops are in


#pulling the acs data
acs_trans <- c("B08301_001", #workers
              "B08301_002", #means of transportation to work: car
              "B08301_003", #means of transportation to work: car, drove alone
              "B08301_010", #means of transportation to work: public transit
              "B08301_011", #means of transportation to work: public transit, bus
              "B08301_012", #means of transportation to work: public transit, subway
              "B08301_013", #means of transportation to work: public transit, commuter rail
              "B08301_014", #means of transportation to work: public transit, light rail/trolley
              "B08301_016", #means of transportation to work: taxicab
              "B08301_018", #means of transportation to work: bicycle
              "B08301_019", #means of transportation to work: walked
              "B08301_021" #means of transportation to work: wfh
              )


routes <- subset(routes_w_ridership, routes_w_ridership$Route %in% full_corridor_results$dat[[1]]$route_id)

## CORRIDOR LEVEL STOP DATA ##

stop_trip_dat <- find_stop_dat(apc_data, stop_list)
daily_stop_analytics <- analyze_stops_daily(stop_trip_dat)
stop_route_analytics <- analyze_stops_routes_daily(stop_trip_dat)
stop_route_binned_analytics <- suppressWarnings(analyze_stops_routes_hourbin(stop_trip_dat))
stop_route_hourly_analytics <- suppressWarnings(analyze_stops_routes_hourly(stop_trip_dat))

# to-do - create a function that returns ordered stop data based on whether it is more of an east-west route or a north-south route
# if it's an east/west route - order it by longitude, if it's a north/south route, order by stop_lat
ordered_stop_dat <- stop_trip_dat %>% 
  group_by(stop_id, stop_name, stop_lat, stop_lon) %>% 
  summarise() %>% 
  mutate(stop_name_2 = stop_name) %>% 
  separate(stop_name_2, c("on_street", "at_street"), sep = "&") %>% 
  arrange(stop_lon)

# helper function to create a readable sentence version of a list of routes (or stops)
create_route_sentence <- function(route_list) {
  
  first_routes <- (route_list[1:length(route_list)-1] %>% unlist()) %>% paste0(sep = ", ", collapse = '')
  last_route <- route_list[length(route_list)]
  
  output <- paste0(first_routes, "and ", last_route)
  
  return(output)
}


```

```{r}
# ZOE - what's going on here? something we can delete? 




```


The Olney transit corridor runs along `r ordered_stop_dat$on_street %>% unique() %>% create_route_sentence()` between `r first(ordered_stop_dat$at_street)` and `r last(ordered_stop_dat$at_street)`. The corridor serves the routes `r create_route_sentence(unique(stop_route_analytics$route_id))`. There are `r length(subcorridors[[3]][[1]])` total bus stops along the corridor, with the average bus trip running past `r round(mean(subcorridors_dat[[4]][[1]]$n_stops))` stops spanning `r round(mean(subcorridors_dat[[4]][[1]]$distance_traveled),digits=2)` miles.

```{r leaflet_map, include=TRUE, message=FALSE}
  
# map of routes that exist in this corridor
leaflet() %>%
  setView(lng = -75.14511, lat = 40.03905, zoom = 13) %>% 
  addProviderTiles(providers$Stamen.Toner) %>% 
  addCircleMarkers(daily_stop_analytics, lat = daily_stop_analytics$stop_lat, lng = daily_stop_analytics$stop_lon, radius = (daily_stop_analytics$total_ons + daily_stop_analytics$total_offs)/100, color = "blue")
  #addPolylines(data = routes_w_ridership, color = "#4377bc", weight = 4, layerId = link_stop_data$fromto, opacity = 0.5)

# also add chart/table of global averages for context of subcorridors
```


### Full Corridor Analytics 

These charts illustrate characteristics for the Olney corridor as a whole, such as average speed and ridership. Average speed, as well as ridership., vary both by route and by time of day.

#### Full Corridor Daily Analytics
```{r corridor_table}

table_1 <- full_corridor_results$route_analytics[[1]] %>% bind_rows(full_corridor_results$analytics[[1]] %>% mutate(route_id = "Total"))
 
kable(table_1, booktabs = TRUE, align = 'c',format.args = list(big.mark = ","),digits=1) %>%
  kable_styling(latex_options = "scale_down")  %>%
  row_spec(dim(table_1)[1], bold = T) %>% # format last row
  column_spec(1, italic = T) %>%  # format first column
  scroll_box(width = "100%", height = "300px")
```

#### Weekday Ridership

```{r ridership_plots, echo=FALSE, out.width='100%', fig.height = 5, warning=FALSE}
full_corridor_results$ridership_by_period_plot[[1]]
full_corridor_results$ridership_by_route_plot[[1]]
full_corridor_results$ridership_by_route_dir_plot[[1]]

```

#### Speed and Reliability
Speed and reliability are two of the most important aspects governing how attractive transit is to the customer. 

There is, however, an important distinction between transit speed and transit reliability:
- speed is how fast the vehicle is moving through the corridor
- reliability is how consistent those speeds are, throughout a day or another period of time. 

Oftentimes, qualitative research on transit finds that riders remember their worst trip much more vividly than their average (or even their best) trips. This is where reliability is key - providing customers with a consistent trip time is just as important as a fast trip time, because when they budget time for future trips, they have to be reasonably sure that the time budgeted will represent the majority of potential travel time outcomes.

##### Speed
```{r speed_plots, echo=FALSE, out.width='100%', fig.height = 5, warning=FALSE}

full_corridor_results$hourly_speed_plot[[1]]
full_corridor_results$speed_by_period_plot[[1]]
full_corridor_results$speed_by_route_dir_plot[[1]]

```

##### Reliability
```{r reliability_plots, echo=FALSE, out.width='100%', fig.height = 5, warning=FALSE}

# NEED - develop a reliability plot or two

```

#### End-to-End Travel Time
Corridor-level travel time is simply the amount of time it takes the bus to travel from one end of the corridor to another. In this case, it is show separated by route and by direction and is averaged for each hour. 
```{r running_time_plots, echo=FALSE, out.width='100%', fig.height = 5, warning=FALSE}

full_corridor_results$running_time_dir_plot[[1]]

```

#### Service Hours
Service hours are a measure of how much transit is operated on the corridor. It is simply the sum of all of the runtime on the corridor over a period of time. Service hours is  a product of how much transit is provide, but it is also a product of the speed of operations on a corridor. Transit productivity is often measured in terms of service hours because it is the most direct input into the cost of running the service. 
```{r service_hours_plots, echo=FALSE, out.width='100%', fig.height = 5, warning=FALSE}

full_corridor_results$service_hrs_plot[[1]]

```

## Sub-Corridor Analysis


```{r subcorridors, echo=FALSE, results='asis'}
i = 1
for(i in 1:length(subcorridors_results$subcorridor_id)){
  
  knitrenv <- new.env()
  assign("subcorridor_results_line", subcorridors_results[i, ], knitrenv)
  
  res <- knitr::knit_child('subcorridors.Rmd', quiet = TRUE, envir = knitrenv)
  cat(res, sep = '\n')
  
}


```






